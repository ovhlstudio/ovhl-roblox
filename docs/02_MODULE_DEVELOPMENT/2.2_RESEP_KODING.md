# üç≥ OVHL CORE - RESEP KODING (COOKBOOK)

## üìã INFORMASI DOKUMEN

| Properti            | Nilai                                                             |
| ------------------- | ----------------------------------------------------------------- |
| **ID Dokumen**      | `RECIPE-001`                                                      |
| **Versi Dokumen**   | `1.0.0`                                                           |
| **Status**          | `Aktif (Baru)`                                                    |
| **Lokasi Path**     | `./docs/02_MODULE_DEVELOPMENT/2.2_RESEP_KODING.md`                |
| **Repository**      | `https://github.com/ovhlstudio/ovhl-roblox`                       |
| **Lisensi**         | `MIT`                                                             |
| **Relasi**          | `ARCHITECTURE.md`, `API_REFERENCE.md`, `DEVELOPMENT_STANDARDS.md` |
| **Penulis**         | `OVHL Core Team`                                                  |
| **Dibuat Tanggal**  | `28 Oktober 2025`                                                 |
| **Update Terakhir** | `28 Oktober 2025`                                                 |

---

## üìñ Pengantar

Selamat datang di "Cookbook" OVHL Core! Dokumen ini berisi kumpulan "resep" atau contoh kode praktis untuk menyelesaikan tugas-tugas umum saat membuat modul game. Fokusnya adalah **bagaimana melakukan sesuatu** dengan cepat menggunakan API `OVHL`.

**Asumsi:**

- Anda sudah melakukan setup sesuai `1.2_PANDUAN_AWAL.md`.
- Anda sudah memahami konsep dasar `OVHL` Global Accessor.
- Anda tahu cara membuat file modul baru dan menambahkan `__manifest`.

**Cara Membaca Resep:**
Setiap resep akan mencakup:

1.  **Kasus Penggunaan:** Masalah yang ingin diselesaikan.
2.  **Kode Snippet:** Potongan kode relevan (bukan file lengkap) yang bisa Anda adaptasi.
3.  **Penjelasan:** Langkah-langkah kunci dalam kode tersebut.

---

## üé® Resep 1: Membuat & Menampilkan UI Sederhana (Coin Display)

**Kasus Penggunaan:** Anda ingin menampilkan jumlah koin pemain di layar, dan UI tersebut harus otomatis update jika jumlah koin berubah.

**Kode Snippet (`src/client/modules/ui/MyCoinDisplay.lua`):**

```lua
-- File: src/client/modules/ui/MyCoinDisplay.lua
local OVHL = require(game.ReplicatedStorage.OVHL_Shared.OVHL_Global)
local BaseComponent = require(script.Parent.Parent.Parent.lib.BaseComponent)

local MyCoinDisplay = setmetatable({}, BaseComponent)
MyCoinDisplay.__index = MyCoinDisplay

-- WAJIB: Manifest untuk auto-discovery
MyCoinDisplay.__manifest = {
    name = "MyCoinDisplay", version = "1.0.0", type = "module", domain = "ui",
    dependencies = {"StateManager"}
}

-- 1. Init: Ambil state awal
function MyCoinDisplay:Init()
    BaseComponent.Init(self)
    self.state = {
        coins = OVHL:GetState("coins", 0) -- Ambil 'coins', default 0 jika belum ada
    }
    self.connections = {} -- Untuk menyimpan koneksi event
end

-- 2. DidMount: Subscribe ke perubahan state
function MyCoinDisplay:DidMount()
    local unsub = OVHL:Subscribe("coins", function(newCoins)
        self:SetState({ coins = newCoins }) -- Update state internal & trigger re-render
    end)
    table.insert(self.connections, unsub) -- Simpan fungsi unsubscribe
end

-- 3. WillUnmount: WAJIB Cleanup!
function MyCoinDisplay:WillUnmount()
    for _, unsub in ipairs(self.connections) do
        unsub() -- Panggil fungsi unsubscribe
    end
end

-- 4. Render: Membuat tampilan UI
function MyCoinDisplay:Render()
    local StyleManager = OVHL:GetService("StyleManager")

    local frame = Instance.new("TextLabel")
    frame.Size = UDim2.fromOffset(150, 40)
    frame.Position = UDim2.new(0, 10, 0, 10) -- Pojok kiri atas
    frame.BackgroundColor3 = StyleManager:GetColor("surface")
    frame.TextColor3 = StyleManager:GetColor("text")
    frame.TextSize = 16
    frame.Font = Enum.Font.GothamSemibold
    frame.Text = "üí∞ " .. self.state.coins -- Tampilkan state 'coins'

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = frame

    return frame
end

return MyCoinDisplay
```

**Penjelasan:**

1.  **`Init`**: Mengambil nilai `coins` saat ini dari `StateManager` menggunakan `OVHL:GetState`.
2.  **`DidMount`**: Setelah UI muncul, kita "mendengarkan" perubahan _state_ `coins` menggunakan `OVHL:Subscribe`. Jika `coins` berubah, kita panggil `self:SetState` untuk memperbarui nilai internal dan memicu `Render` ulang. Fungsi `unsub` disimpan.
3.  **`WillUnmount`**: Sebelum UI hilang, kita **wajib** memanggil semua fungsi `unsub` yang disimpan untuk menghentikan pendengaran dan mencegah _memory leak_.
4.  **`Render`**: Membuat `TextLabel` sederhana yang menampilkan teks berdasarkan `self.state.coins`.

---

## üíæ Resep 2: Menyimpan Data Player (Sederhana)

**Kasus Penggunaan:** Anda ingin menyimpan progres level pemain saat dia keluar dari game.

**Kode Snippet (`src/server/modules/gameplay/LevelSystem.lua`):**

```lua
-- File: src/server/modules/gameplay/LevelSystem.lua
local OVHL = require(game.ReplicatedStorage.OVHL_Shared.OVHL_Global)

local LevelSystem = {}
LevelSystem.__index = LevelSystem

LevelSystem.__manifest = {
    name = "LevelSystem", version = "1.0.0", type = "module", domain = "gameplay",
    dependencies = {"Logger", "DataService"}
}

-- Simpan level pemain per UserId
local playerLevels = {}

function LevelSystem:Start()
    self.logger = OVHL:GetService("Logger")
    self.dataService = OVHL:GetService("DataService")

    -- Event saat pemain bergabung (untuk memuat data)
    OVHL:Subscribe("PlayerJoined", function(player)
        self:LoadPlayerLevel(player)
    end)

    -- Event saat pemain keluar (untuk menyimpan data)
    OVHL:Subscribe("PlayerRemoving", function(player)
        self:SavePlayerLevel(player)
    end)
end

function LevelSystem:LoadPlayerLevel(player)
    local userId = player.UserId
    local success, data = pcall(function()
        -- Gunakan DataService untuk ambil data (saat ini masih mock)
        return self.dataService:GetPlayerData(player, "PlayerProgress")
    end)

    if success and data and data.level then
        playerLevels[userId] = data.level
        self.logger:Info("Level dimuat untuk " .. player.Name .. ": " .. data.level)
    else
        playerLevels[userId] = 1 -- Default level 1
        self.logger:Warn("Gagal memuat level untuk " .. player.Name .. ". Default ke 1.", {error = data})
    end
end

function LevelSystem:SavePlayerLevel(player)
    local userId = player.UserId
    local currentLevel = playerLevels[userId]

    if not currentLevel then return end -- Tidak ada data untuk disimpan

    local success, err = pcall(function()
        -- Gunakan DataService untuk simpan data (saat ini masih mock)
        -- Idealnya, kita hanya update field 'level', bukan seluruh data
        local currentData = { level = currentLevel } -- Anggap kita hanya simpan level
        return self.dataService:SetPlayerData(player, "PlayerProgress", currentData)
    end)

    if not success then
        self.logger:Error("Gagal menyimpan level untuk " .. player.Name, {error = err})
    else
        self.logger:Info("Level disimpan untuk " .. player.Name .. ": " .. currentLevel)
        playerLevels[userId] = nil -- Hapus dari memori setelah disimpan
    end
end

-- Fungsi lain (misal: untuk naik level)
function LevelSystem:IncreaseLevel(player)
    local userId = player.UserId
    if playerLevels[userId] then
        playerLevels[userId] = playerLevels[userId] + 1
        -- Emit event agar modul lain tahu (misal: UI)
        OVHL:Emit("PlayerLevelUp", player, playerLevels[userId])
    end
end

return LevelSystem
```

**Penjelasan:**

1.  **`Start`**: Kita subscribe ke _event_ `PlayerJoined` dan `PlayerRemoving`.
2.  **`LoadPlayerLevel`**: Saat pemain masuk, kita panggil `OVHL:GetService("DataService"):GetPlayerData` di dalam `pcall`. Jika berhasil, simpan level ke tabel `playerLevels`. Jika gagal, gunakan level default.
3.  **`SavePlayerLevel`**: Saat pemain keluar, kita ambil level terakhir dari `playerLevels`, lalu panggil `OVHL:GetService("DataService"):SetPlayerData` di dalam `pcall`. Jika berhasil, hapus data dari memori.
4.  **`IncreaseLevel`**: Contoh fungsi internal yang mengubah data di memori (`playerLevels`) dan memberi tahu modul lain melalui `OVHL:Emit`.

---

## üõí Resep 3: Komunikasi Client ke Server (Beli Item)

**Kasus Penggunaan:** Pemain menekan tombol "Beli" di UI Toko, dan server harus memproses pembelian tersebut.

**Kode Snippet Client (`src/client/modules/ui/ShopUI.lua`):**

```lua
-- File: src/client/modules/ui/ShopUI.lua
local OVHL = require(game.ReplicatedStorage.OVHL_Shared.OVHL_Global)
local BaseComponent = require(script.Parent.Parent.Parent.lib.BaseComponent)

local ShopUI = setmetatable({}, BaseComponent)
ShopUI.__index = ShopUI

ShopUI.__manifest = { name = "ShopUI", ... } -- Jangan lupa manifest

function ShopUI:Render()
    local buyButton = Instance.new("TextButton")
    -- ... setup tombol ...

    buyButton.MouseButton1Click:Connect(function()
        self:TryBuyItem("Sword") -- Panggil fungsi internal saat tombol diklik
    end)

    -- ... sisa render ...
    return frame
end

function ShopUI:TryBuyItem(itemId)
    -- Tampilkan loading atau feedback ke user (opsional)
    print("Mencoba membeli:", itemId)

    -- Panggil server menggunakan OVHL:Invoke (menunggu balasan)
    local success, result = pcall(OVHL.Invoke, OVHL, "Shop:BuyItem", itemId)

    if not success then
        -- Error network atau server error
        OVHL:GetService("Logger"):Error("Invoke Shop:BuyItem gagal", {error = result})
        -- Tampilkan pesan error ke user
    elseif result.success then
        -- Pembelian BERHASIL (Server mengembalikan {success = true, ...})
        print("Pembelian berhasil!")
        -- StateManager akan diupdate oleh server (jika perlu) atau bisa update manual
        -- OVHL:SetState("coins", result.newCoins)
    else
        -- Pembelian GAGAL (Server mengembalikan {success = false, error = "..."})
        OVHL:GetService("Logger"):Warn("Pembelian ditolak server", {reason = result.error})
        -- Tampilkan pesan alasan kegagalan ke user
    end
end

return ShopUI
```

**Kode Snippet Server (`src/server/modules/gameplay/ShopModule.lua`):**

```lua
-- File: src/server/modules/gameplay/ShopModule.lua
local OVHL = require(game.ReplicatedStorage.OVHL_Shared.OVHL_Global)

local ShopModule = {}
ShopModule.__index = ShopModule

ShopModule.__manifest = {
    name = "ShopModule", version = "1.0.0", type = "module", domain = "gameplay",
    dependencies = {"Logger", "EconomyService", "InventoryService", "RemoteManager"}
}

local itemPrices = { Sword = 100, Shield = 150 } -- Contoh data harga

function ShopModule:Start()
    self.logger = OVHL:GetService("Logger")

    -- Daftarkan handler ke RemoteManager
    local RemoteManager = OVHL:GetService("RemoteManager")
    RemoteManager:RegisterHandler("Shop:BuyItem", function(player, itemId)
        -- Panggil fungsi internal untuk memproses
        return self:ProcessPurchase(player, itemId)
    end)
end

function ShopModule:ProcessPurchase(player, itemId)
    -- WAJIB: Validasi input dari Client & bungkus pcall
    local success, result = pcall(function()
        -- 1. Validasi Item ID
        local price = itemPrices[itemId]
        if not price then
            error("Item tidak valid: " .. tostring(itemId)) -- error() akan ditangkap pcall
        end

        -- 2. Ambil Service Lain via OVHL
        local EconomyService = OVHL:GetService("EconomyService")
        local InventoryService = OVHL:GetService("InventoryService")

        -- 3. Cek Uang & Inventory (Asumsi service ini punya API-nya)
        if not EconomyService:HasEnoughCoins(player, price) then
            return { success = false, error = "Koin tidak cukup." }
        end
        if not InventoryService:HasFreeSlot(player) then
            return { success = false, error = "Inventory penuh." }
        end

        -- 4. Lakukan Transaksi (Kurangi koin, tambah item)
        local coinSuccess = EconomyService:DecreaseCoins(player, price)
        local itemSuccess = InventoryService:AddItem(player, itemId)

        if not (coinSuccess and itemSuccess) then
            -- Rollback jika salah satu gagal (PENTING!)
            EconomyService:IncreaseCoins(player, price) -- Kembalikan uang
            error("Transaksi gagal saat update data.") -- Akan ditangkap pcall
        end

        -- 5. Ambil data terbaru untuk dikirim balik (jika perlu)
        local newCoins = EconomyService:GetCoins(player)

        return { success = true, newItemId = itemId, newCoins = newCoins }
    end)

    if not success then
        self.logger:Error("ProcessPurchase gagal untuk " .. player.Name, {itemId=itemId, error=result})
        -- Kirim pesan error umum ke client
        return { success = false, error = "Terjadi kesalahan internal." }
    else
        -- Jika pcall sukses, result bisa jadi {success=true, ...} atau {success=false, ...}
        if result.success then
             OVHL:Emit("ItemPurchased", player, itemId) -- Beri tahu modul lain (opsional)
        end
        return result
    end
end

return ShopModule
```

**Penjelasan:**

1.  **Client:** Menggunakan `OVHL:Invoke` untuk memanggil fungsi `Shop:BuyItem` di server dan menunggu _response_. Hasilnya dibungkus `pcall` untuk menangani _error network_.
2.  **Server (Start):** Mendaftarkan _handler_ `Shop:BuyItem` ke `RemoteManager`.
3.  **Server (ProcessPurchase):**
    - Seluruh logika dibungkus `pcall`.
    - Melakukan **validasi** input (`itemId`, uang cukup, slot inventory).
    - Menggunakan `OVHL:GetService` untuk berinteraksi dengan _service_ lain.
    - Mengembalikan tabel `{success = true/false, ...}` ke _client_.

---

## üì¢ Resep 4: Komunikasi Antar Modul Server (Event)

**Kasus Penggunaan:** Saat `LevelSystem` menaikkan level pemain, `AchievementSystem` perlu tahu untuk mengecek apakah ada _achievement_ "Naik Level" yang terbuka.

**Kode Snippet Emitter (`src/server/modules/gameplay/LevelSystem.lua`):**

```lua
-- (Sambungan dari Resep 2)
function LevelSystem:IncreaseLevel(player)
    local userId = player.UserId
    if playerLevels[userId] then
        playerLevels[userId] = playerLevels[userId] + 1
        local newLevel = playerLevels[userId]

        -- Emit event menggunakan OVHL:Emit
        OVHL:Emit("PlayerLevelUp", player, newLevel)

        self.logger:Info(player.Name .. " naik ke level " .. newLevel)
    end
end
```

**Kode Snippet Listener (`src/server/modules/gameplay/AchievementSystem.lua`):**

```lua
-- File: src/server/modules/gameplay/AchievementSystem.lua
local OVHL = require(game.ReplicatedStorage.OVHL_Shared.OVHL_Global)

local AchievementSystem = {}
AchievementSystem.__index = AchievementSystem

AchievementSystem.__manifest = {
    name = "AchievementSystem", version = "1.0.0", type = "module", domain = "gameplay",
    dependencies = {"Logger"}
}

function AchievementSystem:Start()
    self.logger = OVHL:GetService("Logger")

    -- Subscribe ke event menggunakan OVHL:Subscribe
    OVHL:Subscribe("PlayerLevelUp", function(player, newLevel)
        -- Bungkus logika handler dengan pcall
        local success, err = pcall(function()
            self:CheckLevelUpAchievement(player, newLevel)
        end)
        if not success then
            self.logger:Error("Error di handler PlayerLevelUp", {error = err})
        end
    end)
end

function AchievementSystem:CheckLevelUpAchievement(player, newLevel)
    self.logger:Info("Mengecek achievement level up untuk " .. player.Name .. " di level " .. newLevel)
    -- ... (Logika cek achievement) ...
    if newLevel == 10 then
        -- Berikan achievement
        print("Achievement Unlocked: Level 10!")
    end
end

return AchievementSystem
```

**Penjelasan:**

1.  **Emitter (`LevelSystem`):** Setelah menaikkan level, ia memanggil `OVHL:Emit("PlayerLevelUp", player, newLevel)`. Dia tidak peduli siapa yang mendengarkan.
2.  **Listener (`AchievementSystem`):** Di fungsi `Start`, ia memanggil `OVHL:Subscribe("PlayerLevelUp", function(...) ... end)`. _Callback function_ akan otomatis dipanggil setiap kali _event_ `PlayerLevelUp` di-_emit_.
3.  **Penting:** Logika di dalam _callback_ `Subscribe` **wajib** dibungkus `pcall` karena bisa dipanggil kapan saja dan tidak boleh mengganggu _emitter_ atau _listener_ lain jika error.

---

_(Tambahkan resep lain di sini sesuai kebutuhan)_

## üîÑ Riwayat Perubahan (Changelog)

| Versi     | Tanggal         | Penulis            | Perubahan                                   |
| --------- | --------------- | ------------------ | ------------------------------------------- |
| **1.0.0** | **28 Okt 2025** | **OVHL Core Team** | Rilis awal dokumen Resep Koding (Cookbook). |

---

<p align="center">
  <small>Hak Cipta ¬© 2025 OVHL Studio. Semua Hak Dilindungi.</small>
</p>
